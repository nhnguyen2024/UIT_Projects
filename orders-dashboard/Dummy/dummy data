import pandas as pd
import numpy as np
import random
from datetime import datetime, timedelta
import os

# ==========================================
# C·∫§U H√åNH
# ==========================================
START_DATE = datetime(2025, 9, 1)
END_DATE = datetime(2025, 12, 31)

# S·ªë l∆∞·ª£ng SKU trong kho (Catalog)
NUM_SKUS = 200 

# C·∫•u h√¨nh file output (L∆∞u c√πng th∆∞ m·ª•c code)
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
FILES = {
    "web": os.path.join(BASE_DIR, "orders_web.csv"),
    "app": os.path.join(BASE_DIR, "orders_app.csv"),
    "items": os.path.join(BASE_DIR, "items.csv"),
    "channels": os.path.join(BASE_DIR, "channels.csv")
}

# ==========================================
# 1. T·∫†O CATALOG S·∫¢N PH·∫®M GI·∫¢ (200 ITEMS)
# ==========================================
def generate_catalog(n=200):
    catalog = []
    for i in range(1, n + 1):
        catalog.append({
            "sku": f"SKU_{i:03d}", # V√≠ d·ª•: SKU_001
            "price": round(random.uniform(10, 500), 2) # Gi√° t·ª´ $10 ƒë·∫øn $500
        })
    return catalog

# ==========================================
# 2. H√ÄM SINH D·ªÆ LI·ªÜU ƒê∆†N H√ÄNG
# ==========================================
def generate_orders_and_items():
    print("‚è≥ ƒêang kh·ªüi t·∫°o d·ªØ li·ªáu gi·∫£ l·∫≠p... Vui l√≤ng ƒë·ª£i.")
    
    catalog = generate_catalog(NUM_SKUS)
    
    orders_web = []
    orders_app = []
    order_items = []
    
    current_date = START_DATE
    global_order_id = 1000 # B·∫Øt ƒë·∫ßu ID ƒë∆°n h√†ng t·ª´ 1000
    global_item_id = 1     # ID cho b·∫£ng items
    
    # Duy·ªát qua t·ª´ng ng√†y
    total_days = (END_DATE - START_DATE).days + 1
    
    for day_idx in range(total_days):
        # Ng√†y hi·ªán t·∫°i
        date_str = current_date.strftime("%Y-%m-%d")
        
        # --- A. SINH D·ªÆ LI·ªÜU WEB (50 - 200 ƒë∆°n/ng√†y) ---
        num_web = random.randint(50, 200)
        for _ in range(num_web):
            # T·∫°o th√¥ng tin ƒë∆°n h√†ng
            status = np.random.choice(
                ['completed', 'returned', 'cancelled', 'processing'], 
                p=[0.7, 0.1, 0.1, 0.1] # T·ª∑ l·ªá tr·∫°ng th√°i
            )
            
            # Update time l√† ng·∫´u nhi√™n trong ng√†y
            time_offset = random.randint(0, 86399) # gi√¢y trong ng√†y
            updated_at = current_date + timedelta(seconds=time_offset)
            
            orders_web.append([
                global_order_id,
                1, # Channel ID 1 = Web
                date_str,
                status,
                updated_at.strftime("%Y-%m-%d %H:%M:%S")
            ])
            
            # T·∫°o chi ti·∫øt ƒë∆°n h√†ng (Mua 1-5 s·∫£n ph·∫©m ng·∫´u nhi√™n)
            num_products = random.randint(1, 5)
            selected_products = random.sample(catalog, num_products)
            
            for prod in selected_products:
                qty = random.randint(1, 3)
                order_items.append([
                    global_item_id,
                    global_order_id,
                    prod['sku'],
                    qty,
                    prod['price']
                ])
                global_item_id += 1
            
            global_order_id += 1

        # --- B. SINH D·ªÆ LI·ªÜU APP (20 - 80 ƒë∆°n/ng√†y) ---
        num_app = random.randint(20, 80)
        for _ in range(num_app):
            status = np.random.choice(
                ['completed', 'returned', 'cancelled'], 
                p=[0.8, 0.15, 0.05]
            )
            
            time_offset = random.randint(0, 86399)
            updated_at = current_date + timedelta(seconds=time_offset)
            
            orders_app.append([
                global_order_id,
                2, # Channel ID 2 = App
                date_str,
                status,
                updated_at.strftime("%Y-%m-%d %H:%M:%S")
            ])
            
            # T·∫°o items cho App
            num_products = random.randint(1, 3) # App mua √≠t m√≥n h∆°n
            selected_products = random.sample(catalog, num_products)
            
            for prod in selected_products:
                qty = random.randint(1, 2)
                order_items.append([
                    global_item_id,
                    global_order_id,
                    prod['sku'],
                    qty,
                    prod['price']
                ])
                global_item_id += 1
                
            global_order_id += 1
            
        current_date += timedelta(days=1)

    # ==========================================
    # 3. XU·∫§T FILE CSV
    # ==========================================
    print(f"üìä T·ªïng k·∫øt:")
    print(f"- S·ªë ng√†y gi·∫£ l·∫≠p: {total_days}")
    print(f"- ƒê∆°n Web: {len(orders_web)}")
    print(f"- ƒê∆°n App: {len(orders_app)}")
    print(f"- T·ªïng d√≤ng Items: {len(order_items)}")

    # Convert to DataFrame
    df_web = pd.DataFrame(orders_web, columns=['order_id', 'channel_id', 'order_date', 'status', 'updated_at'])
    df_app = pd.DataFrame(orders_app, columns=['order_id', 'channel_id', 'order_date', 'status', 'updated_at'])
    df_items = pd.DataFrame(order_items, columns=['item_id', 'order_id', 'sku', 'quantity', 'unit_price'])
    
    df_channels = pd.DataFrame([
        [1, "Website"],
        [2, "Mobile App"]
    ], columns=['channel_id', 'channel_name'])

    # Save CSV
    df_web.to_csv(FILES['web'], index=False)
    df_app.to_csv(FILES['app'], index=False)
    df_items.to_csv(FILES['items'], index=False)
    df_channels.to_csv(FILES['channels'], index=False)

    print(f"‚úÖ ƒê√£ t·∫°o th√†nh c√¥ng 4 file CSV t·∫°i: {BASE_DIR}")

if __name__ == "__main__":
    generate_orders_and_items()
